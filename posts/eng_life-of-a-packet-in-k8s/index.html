<!DOCTYPE html><html lang="en" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="[번역] Life of a Packet in Kubernetes— Part 3" /><meta property="og:locale" content="en" /><meta name="description" content="해당 Posting 을 공부하며 번역하는 글입니다." /><meta property="og:description" content="해당 Posting 을 공부하며 번역하는 글입니다." /><link rel="canonical" href="https://hhhyunwoo.github.io//posts/eng_life-of-a-packet-in-k8s/" /><meta property="og:url" content="https://hhhyunwoo.github.io//posts/eng_life-of-a-packet-in-k8s/" /><meta property="og:site_name" content="Hans H. Kim" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-05-30T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[번역] Life of a Packet in Kubernetes— Part 3" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-30T00:00:00+09:00","datePublished":"2023-05-30T00:00:00+09:00","description":"해당 Posting 을 공부하며 번역하는 글입니다.","headline":"[번역] Life of a Packet in Kubernetes— Part 3","mainEntityOfPage":{"@type":"WebPage","@id":"https://hhhyunwoo.github.io//posts/eng_life-of-a-packet-in-k8s/"},"url":"https://hhhyunwoo.github.io//posts/eng_life-of-a-packet-in-k8s/"}</script><title>[번역] Life of a Packet in Kubernetes— Part 3 | Hans H. Kim</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Hans H. Kim"><meta name="application-name" content="Hans H. Kim"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/newyork_hw.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hans H. Kim</a></div><div class="site-subtitle font-italic">Machine Learning Engineer <br> <br> Keep Blizt and Be Simple</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/all-posts/" class="nav-link"> <i class="fa-fw fas fa-blog ml-xl-3 mr-xl-3 unloaded"></i> <span>POSTS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/hhhyunwoo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hyunwoo.h.kim','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[번역] Life of a Packet in Kubernetes— Part 3</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[번역] Life of a Packet in Kubernetes— Part 3</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Hans H. Kim </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, May 30, 2023, 12:00 AM +0900" >May 30, 2023<i class="unloaded">2023-05-30T00:00:00+09:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6274 words">34 min read</span></div></div><div class="post-content"><blockquote><p><a href="https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-3-dd881476da0f"><strong>해당 Posting</strong></a> 을 공부하며 번역하는 글입니다.</p></blockquote><p>이번 포스팅은 “<code class="language-plaintext highlighter-rouge">쿠버네티스에서 패킷의 삶</code>” 이라는 주제의 파트 3입니다.</p><p>이제부터 쿠버네티스의 <code class="language-plaintext highlighter-rouge">kube-proxy</code> 컴포넌트가 <code class="language-plaintext highlighter-rouge">iptables</code> 를 사용하여서 어떻게 트래픽을 컨트롤하는지 알아볼 것입니다.</p><p>쿠버네티스 환경에서 <code class="language-plaintext highlighter-rouge">kube-proxy</code> 의 역할을 이해하고 <code class="language-plaintext highlighter-rouge">iptables</code>를 사용하여 어떻게 트래픽을 컨트롤하는지 아는 것은 매우 중요한 부분입니다.</p><p>Note : 트래픽 흐름을 제어하는데 사용할 수 있는 툴과 플러그인은 매우 다양하지만 여기서는 <code class="language-plaintext highlighter-rouge">kube-proxy + iptables</code> 콤보를 이용해서 알아보겠습니다.</p><p>일단 먼저 쿠버네티스에서 제공하는 다양한 커뮤니케이션 모델들과 그들의 구현에 대해서 알아보겠습니다.</p><p>만약 여러분이 <code class="language-plaintext highlighter-rouge">Service</code>, <code class="language-plaintext highlighter-rouge">ClusterIP</code>, <code class="language-plaintext highlighter-rouge">Noteport</code> 의 개념에 대해서 잘 알고계신다면, <code class="language-plaintext highlighter-rouge">kube-proxy/iptables</code> 챕터로 넘어가도 되겠습니다!</p><h2 id="part-1basic-container-networking"><strong>Part 1 — <a href="https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-1-f9bc0909e051?source=friends_link&amp;sk=9525ced03e4683afca531c21914625eb">Basic container networking</a></strong></h2><h2 id="part-2-calico-cni"><strong>Part 2 — <a href="https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-2-a07f5bf0ff14?source=friends_link&amp;sk=2e9f25db9d4f5d9ca85ecd3a08db1c07">Calico CNI</a></strong></h2><h2 id="part-3"><strong>Part 3:</strong></h2><ol><li>Pod-to-Pod<li>Pod-to-External<li>Pod-to-Service<li>External-to-Pod<li>External Traffic Policy<li>Kube-Proxy<li>iptable rules processing flow<li>Network Policy basics</ol><h2 id="kube-proxy-iptable-mode"><strong>Kube-Proxy (iptable mode)</strong></h2><p>쿠버네티스에서 Service 를 구현하는 컴포넌트는 Kube-proxy 입니다.</p><p>모든 노드에 존재하며 파드와 서비스 간에 다양한 종류의 필터링과 NAT 를 수행할 수 있도록 복잡한 iptables 룰들이 프로그램되어있습니다.</p><blockquote><p><strong>NAT</strong> <code class="language-plaintext highlighter-rouge">(Network Address Translation)</code> 란? → IP 패킷에 있는 출발지 및 목적지의 IP 주소와 TCP/UDP 포트 숫자 등을 바꿔 재기록하면서 네트워크 트래픽을 주고 받게하는 기술입니다.</p></blockquote><blockquote><p><strong>iptables</strong> 이란? → 커널 상에서 netfilter 패킷 필터링 기능을 제어하는 기능입니다. 패킷의 해더를 보고 그 전체 패킷의 방향을 결정하게 됩니다.</p></blockquote><p>여러분이 쿠버네티스 클러스터의 노드에 가서 <code class="language-plaintext highlighter-rouge">iptables-save</code> 명령어를 날리게 되면, 쿠버네티스 혹은 다른 프로그램들에 의해 삽입된 룰들을 확인하실 수 있을 겁니다.</p><p>그 중 가장 중요한 Chain 들은 <code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code>, <code class="language-plaintext highlighter-rouge">KUBE-SVC-*</code> 와 <code class="language-plaintext highlighter-rouge">KUBE-SEP-*</code> 입니다.</p><ul><li><code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code> 는 서비스 패킷들의 앤트리 포인트입니다. 목적지의 IP:Port 를 매칭해주고 적합한 <code class="language-plaintext highlighter-rouge">KUBE-SVC-*</code> 체인으로 패킷을 보내줍니다.<li><code class="language-plaintext highlighter-rouge">KUBE-SVC-*</code> 체인은 로드밸런서 역할을 수행하며 패킷들을 <code class="language-plaintext highlighter-rouge">KUBE-SEP-*</code> 체인으로 동일하게 보내줍니다. 각각의 <code class="language-plaintext highlighter-rouge">KUBE-SVC-*</code> 는 <code class="language-plaintext highlighter-rouge">KUBE-SEP-*</code> 체인과 같은 개수가 존재하는데, 이는 엔드포인트의 수와 동일합니다.<li><code class="language-plaintext highlighter-rouge">KUBE-SEP-*</code> 체인은 <code class="language-plaintext highlighter-rouge">S</code>ervice <code class="language-plaintext highlighter-rouge">E</code>nd<code class="language-plaintext highlighter-rouge">P</code>oint 를 뜻합니다. 이는 단순하게 DNAT 를 수행하는데 즉, 서비스 IP:Port 를 파드의 엔드포인트 IP:Port 로 변환해줍니다.</ul><h3 id="what-is-dnat-and-snat">What is DNAT and SNAT</h3><ul><li>DNAT : Destination NAT<ul><li>도착지 주소를 변경하는 NAT</ul><li>SNAT : Source NAT<ul><li>출발지 주소를 변경하는 NAT</ul></ul><p>DNAT 에 대해서는, conntrack 가 시작되고 상태 머신을 이용하여 상태 연결을 기록하기 시작합니다. 변경된 대상 주소를 기억하고, 반환 패킷이 돌아왔을 때 다시 변경해야 하므로 상태가 필요합니다.</p><p>Iptables 는 패킷의 운명을 결정하기 위해서 conntrack 의 상태 (cstate)에 의존합니다.</p><p>아래의 4가지 conntrack 상태는 특히 중요합니다.</p><ul><li>NEW : conntrack 는 SYN 패킷을 받았을 때 발생하는 이 패킷에 대해서 전혀 모릅니다.<li>ESTABLISHED : conntrack 는 패킷이 handshake 가 완료된 이후에 발생하는 established connection에 속한다는 것을 알고 있습니다.<li>RELATED : 패킷은 어떠한 연결에도 속해있지 않지만 다른 연결과 제휴를 맺고있습니다. 이는 FTP와 같은 프로토콜에 특히 굉장히 유용합니다.<li>INVALID : 패킷에 관하여 어떠한 것이 문제가 있고 conntrack 은 어떻게 처리해야하는지 모릅니다. 이 상태는 Kubernetes 상에서 중요한 역할을 수행합니다.</ul><p>아래는 pod 와 서비스 간에 어떻게 TCP 연결이 이루어지는지를 나타냅니다.</p><p>순차적인 이벤트는 아래와 같습니다.</p><ul><li>왼쪽에 있는 클라이언트 Pod 는 서비스(2.2.2.10:80) 로 패킷을 보냅니다<li>패킷은 클라이언트 노드에 있는 iptable 룰을 통과합니다. 그리고 목적지는 pod IP, 1.1.1.20:80 으로 변경됩니다.<li>서버 Pod 는 패킷을 처리하고 다시 패킷을 1.1.1.10 을 목적지로 보냅니다.<li>패킷은 클라이언트 노드로 돌아오고, conntrack 은 패킷을 인식하고 출발지 주소를 2.2.2.10:80 으로 다시 수정합니다.<li>클라이언트 Pod 는 응답 패킷을 받습니다.</ul><p><img data-proofer-ignore data-src="https://miro.medium.com/v2/resize:fit:1400/1*1u1d1WU1SqTiiJFyHO-X_A.gif" alt="image" class="align-center" /></p><h2 id="iptables">iptables</h2><p>리눅스 운영체제에서 방화벽 운영은 <code class="language-plaintext highlighter-rouge">netfilter</code> 를 사용하여 운영됩니다. 이는 커널 모듈에서 어떤 패킷들이 들어오고 나갈지를 허용하는 부분입니다.</p><p><code class="language-plaintext highlighter-rouge">iptables</code> 는 단순히 <code class="language-plaintext highlighter-rouge">netfilter</code> 의 인터페이스입니다. 이 두가지는 종종 같은 것으로 고려되기도 합니다. 더 나은 관점은 이들을 Backend(netfilter)와 Frontend(iptables)로 바라보는 것입니다.</p><h3 id="chains">Chains</h3><p>각각의 체인들은 특정 업무에 대한 책임이 있습니다.</p><ul><li>PREROUTING<ul><li>이 체인은 패킷이 네트워크 인터페이스에 도착하자마자 어떤 일이 발생할지를 결정합니다. 여러가지 옵션이 있는데, 예를 들어 패킷을 바꾼다거나<em>(아마도 NAT)</em>, 패킷을 누락시킨다거나, 아무것도 하지않고 지나가게해서 다른 곳에서 처리하도록 하는 것들이 있습니다.</ul><li>INPUT<ul><li>이 체인은 가장 인기있는 체인 중 하나이고 우리의 컴퓨터를 해치려고 하는 나쁜 요소들을 피하기 위해서 항상 거의 엄격한 규칙을 포함하고 있습니다. 만약 당신이 포트를 열거나 닫고 싶다면, 이 부분이 당신이 수행해야하는 부분입니다.</ul><li>FORWARD<ul><li>이 체인은 이름에서 확인할 수 있듯이 패킷의 포워딩에 책임이 있습니다. 우리가 만약 컴퓨터를 라우터로 사용하고 싶으면, 이 체인이 우리가 적용해야하는 부분입니다.</ul><li>OUTPUT<ul><li>이 체인은 다른 많은 웹 브라우징이 담당하는 부분입니다. 이 체인이 허락하지 않는다면 당신은 하나의 패킷도 보낼 수 없습니다. 포트가 통신할지 말지 관계없이, 수 많은 옵션들이 존재합니다. 만약 응용 프로그램이 어떤 포트를 사용할지 확실하지 않다면, 아웃바운드 트래픽을 제한하는데 가장 좋은 방법입니다.</ul><li>POSTROUTING<ul><li>이 체인은 패킷이 컴퓨터를 떠나기 전에 마지막으로 추적을 남기는 곳입니다. 여러 작업 중에서 우리가 원하는데로 패킷이 잘 흘러가는지를 확인하는데 사용됩니다. <img width="914" alt="image" src="https://github.com/hhhyunwoo/leetcode/assets/37402136/2c02f261-a423-4a8a-9769-c65dfee15fce" /></ul></ul><p><strong>FORWARD</strong> 체인은 리눅스 서버에서 <code class="language-plaintext highlighter-rouge">ip_forward</code> 가 enabled 일때만 사용이 가능합니다. 따라서 Kubernetes 클러스터를 구축하고 디버깅하는데 아래의 커맨드는 매우 중요합니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>node-1<span class="nv">$ </span>sysctl <span class="nt">-w</span> net.ipv4.ip_forward<span class="o">=</span>1
net.ipv4.ip_forward <span class="o">=</span> 1
node-1<span class="nv">$ </span><span class="nb">cat</span> /proc/sys/net/ipv4/ip_forward
1
</pre></table></code></div></div><p>위의 변화는 지속적이지 않습니다. 리눅스 시스템에서 해당 IP를 영구적으로 이용가능하게 하기위해서는 <code class="language-plaintext highlighter-rouge">/etc/sysctl.conf</code> 파일을 아래와 같이 수정해야합니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>net.ipv4.ip_forward <span class="o">=</span> 1
</pre></table></code></div></div><h2 id="tables">tables</h2><p>이제부터 우린 NAT 테이블에 초점을 맞출 예정이지만, 아래는 사용가능한 테이블들에 대한 설명입니다.</p><ul><li>Filter<ul><li>기본 테이블입니다. 이 테이블에서는 패킷이 당신의 컴퓨터로 들어올지 말지를 결정합니다. 만약 포트를 막아서 더 이상 아무것도 받고싶지 않다면 이 부분을 멈춰야합니다.</ul><li>Nat<ul><li>이 테이블은 두번째로 인기있는 테이블이고 새로운 연결을 생성하는데 책임이 있습니다. Network Address Translation 의 줄임말이기도 합니다. 만약 당신이 이 용어에 익숙하지 않아도 괜챃습니다. 아래에서 자세하게 설명하겠습니다.</ul><li>Mangle<ul><li>특별한 패킷만을 다룹니다. 이 테이블은 들어오고 나가는 패킷 내부의 무언가를 변경합니다.</ul><li>Raw<ul><li>이 테이블은 이름에서 추측할 수 있듯이 raw 패킷을 다룹니다. 주로 연결 상태를 추적합니다. 아래에서 SSH 연결에서 성공한 패킷을 허가하는 예시를 살펴보겠습니다.</ul><li>Security<ul><li>Filter Table 다음으로 컴퓨터 보안을 담당합니다. <a href="https://www.redhat.com/en/topics/linux/what-is-selinux">SELinux</a> 를 포함하고 있습니다. 만약 이 용어와 익숙하지 않다면, 이것은 현대 리눅스 배포판에서 강력한 보안툴입니다.</ul></ul><blockquote><p>만약 iptables 에 대해서 조금 더 자세하기 알고 싶다면 <a href="https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture">이 칼럼</a>을 읽어주시기 바랍니다.</p></blockquote><h2 id="iptable-configuration-in-kubernetes">iptable configuration in Kubernetes</h2><p>자, 이제부터 2개의 래플리카를 가진 <strong>Nginx</strong> 애플리케이션을 minikube에 배포해보고 iptable 규칙을 덤프해봅시다.</p><p>서비스 타입 : NodePort</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>master <span class="nv">$ </span>kubectl get svc webapp
NAME TYPE CLUSTER-IP EXTERNAL-IP PORT<span class="o">(</span>S<span class="o">)</span> AGE
webapp NodePort 10.103.46.104 &lt;none&gt; 80:31380/TCP 3d13h
master <span class="nv">$ </span>kubectl get ep webapp 
NAME ENDPOINTS AGE
webapp 10.244.120.102:80,10.244.120.103:80 3d13h
master <span class="err">$</span>
</pre></table></code></div></div><p>위와 같이 Endpoint 를 조회해보면, ClusterIP 는 어디에도 존재하지 않습니다. 다만, 아래에서 볼 수 있듯이 virtual IP 는 iptable Kubernetes 에 존재하고 CoreDNS에 DNS 항목을 추가합니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>master <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-i</span> <span class="nt">-t</span> dnsutils <span class="nt">--</span> nslookup webapp.default
Server:  10.96.0.10
Address: 10.96.0.10#53
Name: webapp.default.svc.cluster.local
Address: 10.103.46.104
</pre></table></code></div></div><p>패킷에 필터링과 NAT를 하기위해서 Kubernetes 는 iptable에 커스텀 체인인 <strong><code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code></strong>를 생성할 것입니다.</p><p>아래에서 볼 수 있듯이 해당 체인은 모든 <code class="language-plaintext highlighter-rouge">PREROUTING AND OUTPUT</code> 트래픽을 커스텀 체인인 <code class="language-plaintext highlighter-rouge">**KUBE-SERVIES**</code> 로 리다이렉트 할 것 입니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> PREROUTING | column <span class="nt">-t</span>
Chain            PREROUTING  <span class="o">(</span>policy  ACCEPT<span class="o">)</span>
target           prot        opt      <span class="nb">source    </span>destination
cali-PREROUTING  all         <span class="nt">--</span>       anywhere  anywhere     /<span class="k">*</span>        cali:6gwbT8clXdHdC1b1  <span class="k">*</span>/
<span class="k">**</span>KUBE-SERVICES<span class="k">**</span>    all         <span class="nt">--</span>       anywhere  anywhere     /<span class="k">*</span>        kubernetes             service   portals  <span class="k">*</span>/
DOCKER           all         <span class="nt">--</span>       anywhere  anywhere     ADDRTYPE  match                  dst-type  LOCAL
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">KUBE-SERVICES</code> 체인 훅을 패킷 필터링과 NAT 로 사용한 후에, Kubernetes 는 자신의 서비스로 들어오는 트래픽을 감지할 수 있고 SNAT/DNAT를 올바르게 적용할 수 있습니다.</p><p><code class="language-plaintext highlighter-rouge">**KUBE-SERVICES**</code> 체인 마지막에는, 특정 서비스 타입인 NODEPORT 에서 트래픽을 조작하기 위해서 <code class="language-plaintext highlighter-rouge">**KUBE-NODEPORTS**</code> 라는 커스텀 체인을 설치해줍니다.</p><p>만약 트래픽이 <code class="language-plaintext highlighter-rouge">ClusterIP 서비스 타입</code>으로 들어오는 것이라면, <code class="language-plaintext highlighter-rouge">KUBE-SVC-2IRACUALRELARSND</code> 체인이 트레픽을 처리할 것입니다. 그것이 아니라면 그 다음 체인인 <code class="language-plaintext highlighter-rouge">KUBE-NODEPORTS</code> 체인에서 트레픽을 처리할 것입니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> KUBE-SERVICES | column <span class="nt">-t</span>
Chain                      KUBE-SERVICES  <span class="o">(</span>2   references<span class="o">)</span>                                                                                                                                                                             
target                     prot           opt  <span class="nb">source          </span>destination                                                                                                                                                             
<span class="k">**</span>KUBE-MARK-MASQ<span class="k">**</span>             tcp            <span class="nt">--</span>   <span class="o">!</span>10.244.0.0/16  10.103.46.104   /<span class="k">*</span>  default/webapp                   cluster  IP          <span class="k">*</span>/     tcp   dpt:www                                                                          
<span class="k">**</span>KUBE-SVC-2IRACUALRELARSND<span class="k">**</span>  tcp            <span class="nt">--</span>   anywhere        10.103.46.104   /<span class="k">*</span>  default/webapp                   cluster  IP          <span class="k">*</span>/     tcp   dpt:www                                                                                                                                             
<span class="k">**</span>KUBE-NODEPORTS<span class="k">**</span>             all            <span class="nt">--</span>   anywhere        anywhere        /<span class="k">*</span>  kubernetes                       service  nodeports<span class="p">;</span>  NOTE:  this  must        be  the  last  rule  <span class="k">in  </span>this  chain  <span class="k">*</span>/  ADDRTYPE  match  dst-type  LOCAL
</pre></table></code></div></div><p>자, 그럼 이제 <code class="language-plaintext highlighter-rouge">KUBE-NODEPORTS</code> 부분에 대해서 알아봅시다.</p><p><em>(제 환경 같은 경우는 k8s v1.21.6 버전을 사용하고있는데요, KUBE-NODE-PORT 라는 이름의 체인으로 등록이 되어있습니다. K8S 버전에 따라 상이한 부분이 있는 듯 합니다.)</em></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> KUBE-NODEPORTS | column <span class="nt">-t</span>
Chain                      KUBE-NODEPORTS  <span class="o">(</span>1   references<span class="o">)</span>                                            
target                     prot            opt  <span class="nb">source       </span>destination                               
KUBE-MARK-MASQ             tcp             <span class="nt">--</span>   anywhere     anywhere     /<span class="k">*</span>  default/webapp  <span class="k">*</span>/  tcp  dpt:31380
KUBE-SVC-2IRACUALRELARSND  tcp             <span class="nt">--</span>   anywhere     anywhere     /<span class="k">*</span>  default/webapp  <span class="k">*</span>/  tcp  dpt:31380
</pre></table></code></div></div><p>이제 이 부분부터는 ClusterIP 와 NodePort 의 처리 과정이 동일합니다.</p><p>아래에서 나오는 iptable의 다이어그램을 참고해주세요</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c"># Statistic mode random -&gt; Random load-balancing between endpoints</span>
<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> KUBE-SVC-2IRACUALRELARSND | column <span class="nt">-t</span>
Chain                      KUBE-SVC-2IRACUALRELARSND  <span class="o">(</span>2   references<span class="o">)</span>                                                                             
target                     prot                       opt  <span class="nb">source       </span>destination                                                                
KUBE-SEP-AO6KYGU752IZFEZ4  all                        <span class="nt">--</span>   anywhere     anywhere     /<span class="k">*</span>  default/webapp  <span class="k">*</span>/  statistic  mode  random  probability  0.50000000000
KUBE-SEP-PJFBSHHDX4VZAOXM  all                        <span class="nt">--</span>   anywhere     anywhere     /<span class="k">*</span>  default/webapp  <span class="k">*</span>/

<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> KUBE-SEP-AO6KYGU752IZFEZ4 | column <span class="nt">-t</span>
Chain           KUBE-SEP-AO6KYGU752IZFEZ4  <span class="o">(</span>1   references<span class="o">)</span>                                               
target          prot                       opt  <span class="nb">source          </span>destination                               
KUBE-MARK-MASQ  all                        <span class="nt">--</span>   10.244.120.102  anywhere     /<span class="k">*</span>  default/webapp  <span class="k">*</span>/       
DNAT            tcp                        <span class="nt">--</span>   anywhere        anywhere     /<span class="k">*</span>  default/webapp  <span class="k">*</span>/  tcp  to:10.244.120.102:80

<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> KUBE-SEP-PJFBSHHDX4VZAOXM | column <span class="nt">-t</span>
Chain           KUBE-SEP-PJFBSHHDX4VZAOXM  <span class="o">(</span>1   references<span class="o">)</span>                                               
target          prot                       opt  <span class="nb">source          </span>destination                               
KUBE-MARK-MASQ  all                        <span class="nt">--</span>   10.244.120.103  anywhere     /<span class="k">*</span>  default/webapp  <span class="k">*</span>/       
DNAT            tcp                        <span class="nt">--</span>   anywhere        anywhere     /<span class="k">*</span>  default/webapp  <span class="k">*</span>/  tcp  to:10.244.120.103:80

<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> KUBE-MARK-MASQ | column <span class="nt">-t</span>
Chain   KUBE-MARK-MASQ  <span class="o">(</span>24  references<span class="o">)</span>                         
target  prot            opt  <span class="nb">source       </span>destination            
MARK    all             <span class="nt">--</span>   anywhere     anywhere     MARK  or  0x4000
</pre></table></code></div></div><p><em>Note : 가독성을 위해서 결과를 잘라내어 필요한 부분들만 보여주는 것입니다.</em></p><h3 id="clusterip">ClusterIP:</h3><ul><li>KUBE-SERVICES → KUBE-SVC-XXXX → KUBE-SEP-XXX</ul><h3 id="nodeport">NodePort:</h3><ul><li>KUBE-SERVICES → KUBE-NODEPORTS → KUBE-SVC-XXX → KUBE-SEP-XXX</ul><p><em>Note: NodePort 서비스는 내부와 외부 트래픽 관리를 위해 할당된 ClusterIP 가 있습니다.</em></p><p>시각적으로 표현된 도표는 아래와 같습니다.</p><p><img width="914" alt="image" src="https://github.com/hhhyunwoo/leetcode/assets/37402136/b2d86c94-9c26-41e2-9d2d-b6173d7bdbff" /></p><h3 id="externaltrafficpolicy-local">ExternalTrafficPolicy: Local</h3><p>이전에 논의된 것 처럼, “externalTrafficPolicy: Local” 을 사용하는 것은 Source IP 를 보존할 수 있고 Local endpoint 가 없는 곳에서 들어오는 패킷은 drop 할 수 있습니다.</p><p>즉, 외부 트래픽에 대한 응답으로 <code class="language-plaintext highlighter-rouge">Service</code>가 노드 안 (Local)에서만 응답을 할 것인지, 아니면 Cluster 전체 (Cluster) 로 나아가서 응답할지 결정하는 옵션입니다.</p><p><em>추가적으로 externalTrafficPolicy : Cluster 로 전체 응답하는 것이 Default 값입니다.</em></p><p>local endpoint 가 없는 경우에 대해서 iptable을 조금 더 들여다 보죠.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>master <span class="nv">$ </span>kubectl get nodes
NAME           STATUS   ROLES    AGE    VERSION
minikube       Ready    master   6d1h   v1.19.2
minikube-m02   Ready    &lt;none&gt;   85m    v1.19.2
</pre></table></code></div></div><p>이제 externalTrafficPolicy Local 을 가진 Nginx 을 배포해보겠습니다!</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>master <span class="nv">$ </span>kubectl get pods nginx-deployment-7759cc5c66-p45tz <span class="nt">-o</span> wide
NAME                                READY   STATUS    RESTARTS   AGE   IP               NODE       NOMINATED NODE   READINESS GATES
nginx-deployment-7759cc5c66-p45tz   1/1     Running   0          29m   10.244.120.111   minikube   &lt;none&gt;           &lt;none&gt;
</pre></table></code></div></div><p>externalTrafficPolicy 를 확인해보죠,</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>master <span class="nv">$ </span>kubectl get svc webapp <span class="nt">-o</span> wide <span class="nt">-o</span> <span class="nv">jsonpath</span><span class="o">={</span>.spec.externalTrafficPolicy<span class="o">}</span>
Local
</pre></table></code></div></div><p>서비스를 가져와보겠습니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>master <span class="nv">$ </span>kubectl get svc webapp <span class="nt">-o</span> wide
NAME     TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE   SELECTOR
webapp   NodePort   10.111.243.62   &lt;none&gt;        80:30080/TCP   29m   <span class="nv">app</span><span class="o">=</span>webserver
</pre></table></code></div></div><p>그럼 이제 minikube-m02 노드에 적용되어있는 iptables 를 확인해보게습니다.</p><p>local endpoint 가 아니라면 패킷을 <code class="language-plaintext highlighter-rouge">DROP</code> 하는 룰이 적용되어있을 것입니다!</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> KUBE-NODEPORTS
Chain KUBE-NODEPORTS <span class="o">(</span>1 references<span class="o">)</span>
target prot opt <span class="nb">source </span>destination
KUBE-MARK-MASQ tcp — 127.0.0.0/8 anywhere /<span class="k">*</span> default/webapp <span class="k">*</span>/ tcp dpt:30080
<span class="k">**</span>KUBE-XLB-2IRACUALRELARSND<span class="k">**</span> tcp — anywhere anywhere /<span class="k">*</span> default/webapp <span class="k">*</span>/ tcp dpt:30080
</pre></table></code></div></div><p><strong><code class="language-plaintext highlighter-rouge">KUBE-XLB-2IRACUALRELARSND</code></strong> 를 확인해보겠습니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> KUBE-XLB-2IRACUALRELARSND
Chain KUBE-XLB-2IRACUALRELARSND <span class="o">(</span>1 references<span class="o">)</span>
target prot opt <span class="nb">source </span>destination
KUBE-SVC-2IRACUALRELARSND all — 10.244.0.0/16 anywhere /<span class="k">*</span> Redirect pods trying to reach external loadbalancer VIP to clusterIP <span class="k">*</span>/
KUBE-MARK-MASQ all — anywhere anywhere /<span class="k">*</span> masquerade LOCAL traffic <span class="k">for </span>default/webapp LB IP <span class="k">*</span>/ ADDRTYPE match src-type LOCAL
KUBE-SVC-2IRACUALRELARSND all — anywhere anywhere /<span class="k">*</span> route LOCAL traffic <span class="k">for </span>default/webapp LB IP to service chain <span class="k">*</span>/ ADDRTYPE match src-type LOCAL
<span class="k">**</span>KUBE-MARK-DROP<span class="k">**</span> all — anywhere anywhere /<span class="k">*</span> default/webapp has no <span class="nb">local </span>endpoints <span class="k">*</span>/
</pre></table></code></div></div><p>조금 더 자세히 들여다보면, Cluster Level의 트래픽에서는 전혀 문제가 없습니다. 오직 nodePort 트래픽이 이 노드에서 drop 될 것 입니다.</p><p>‘minikube’ 노드(master) 의 iptable 룰입니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> KUBE-NODEPORTS
Chain KUBE-NODEPORTS <span class="o">(</span>1 references<span class="o">)</span>
target prot opt <span class="nb">source </span>destination
KUBE-MARK-MASQ tcp — 127.0.0.0/8 anywhere /<span class="k">*</span> default/webapp <span class="k">*</span>/ tcp dpt:30080
KUBE-XLB-2IRACUALRELARSND tcp — anywhere anywhere /<span class="k">*</span> default/webapp <span class="k">*</span>/ tcp dpt:30080

<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> KUBE-XLB-2IRACUALRELARSND
Chain KUBE-XLB-2IRACUALRELARSND <span class="o">(</span>1 references<span class="o">)</span>
target prot opt <span class="nb">source </span>destination
KUBE-SVC-2IRACUALRELARSND all — 10.244.0.0/16 anywhere /<span class="k">*</span> Redirect pods trying to reach external loadbalancer VIP to clusterIP <span class="k">*</span>/
KUBE-MARK-MASQ all — anywhere anywhere /<span class="k">*</span> masquerade LOCAL traffic <span class="k">for </span>default/webapp LB IP <span class="k">*</span>/ ADDRTYPE match src-type LOCAL
KUBE-SVC-2IRACUALRELARSND all — anywhere anywhere /<span class="k">*</span> route LOCAL traffic <span class="k">for </span>default/webapp LB IP to service chain <span class="k">*</span>/ ADDRTYPE match src-type LOCAL
KUBE-SEP-5T4S2ILYSXWY3R2J all — anywhere anywhere /<span class="k">*</span> Balancing rule 0 <span class="k">for </span>default/webapp <span class="k">*</span>/

<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> KUBE-SVC-2IRACUALRELARSND
Chain KUBE-SVC-2IRACUALRELARSND <span class="o">(</span>3 references<span class="o">)</span>
target prot opt <span class="nb">source </span>destination
KUBE-SEP-5T4S2ILYSXWY3R2J all — anywhere anywhere /<span class="k">*</span> default/webapp <span class="k">*</span>/
</pre></table></code></div></div><h2 id="headless-services"><strong>Headless Services</strong></h2><blockquote><p>Kubernetes Docs 에서 가져온 내용</p></blockquote><p>가끔씩 로드밸런싱이 필요없고 Service IP 하나만 필요할 때가 있습니다. 이런 경우, 당신은 Cluster IP (<code class="language-plaintext highlighter-rouge">.spec.clusterIP</code>) 에 “<code class="language-plaintext highlighter-rouge">None</code>”을 특정해서, ‘headless’ 라는 용어를 가진 서비스를 만들 수 있습니다.</p><p>Kubernetes의 구현체에 묶이지 않고, 다른 Discovery Mechanisms 사용할 때 헤드리스 서비스 인터페이스를 사용할 수 있습니다.</p><p>헤드리스 <code class="language-plaintext highlighter-rouge">Services</code> 에서 Cluster IP는 할당되지 않고, Kube-proxy 는 이 서비스를 처리하지 않습니다. 또한 플랫폼 상에서의 로드벨런싱 혹은 Proxying 은 존재하지 않습니다.</p><p>DNS가 어떻게 자동으로 구성되는지는 서비스가 Selector 를 가지고 있는지에 따라 달라집니다.</p><h3 id="with-selectors">With selectors</h3><p>Selector 가 정의된 헤드리스 서비스에서는 엔드포인트 컨트롤러가 API를 이용해 <code class="language-plaintext highlighter-rouge">Endpoints</code> 를 기록하고 <code class="language-plaintext highlighter-rouge">Service</code> 뒤쪽에 위치한 <code class="language-plaintext highlighter-rouge">Pod</code> 로 직접 찌를 수 있도록 DNS 구성을 변경합니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>master <span class="nv">$ </span>kubectl get svc webapp-hs
NAME        TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
webapp-hs   ClusterIP   None         &lt;none&gt;        80/TCP    24s

master <span class="nv">$ </span>kubectl get ep webapp-hs
NAME        ENDPOINTS                             AGE
webapp-hs   10.244.120.109:80,10.244.120.110:80   31s
</pre></table></code></div></div><h3 id="without-selectors">Without selectors</h3><p>Selector 가 정의되지 않은 헤드리스 서비스의 경우 엔드포인트 컨트롤러가 <code class="language-plaintext highlighter-rouge">Endpoint</code> 리소스를 생성하지 않습니다.</p><p>하지만 DNS 시스템은 다음 중 하나를 선택하여 구성합니다.</p><ul><li><code class="language-plaintext highlighter-rouge">ExternalName</code> type 서비스인 경우 <code class="language-plaintext highlighter-rouge">CNAME 레코드</code> 반환<li>다른 모든 타입의 서비스와 이름을 공유하는 아무 Endpoint 의 <code class="language-plaintext highlighter-rouge">A 레코드</code>를 반환</ul><p>만약 하나 혹은 그 이상의 클러스터 노드로 라우팅 해주는 External IP들이 존재한다면, Kubernetes 서비스는 이 external IPs 들로 노출될 수 있습니다.</p><p>Service Port 의 external IP 를 통해 클러스터로 들어오는 트래픽들은 Service 엔드포인트 중 하나로 라우팅 될 것입니다. <code class="language-plaintext highlighter-rouge">external IPs</code> 는 Kubernetes 에 의해 관리되지 않고, 클러스터 관리자가 이들을 책임지고 관리해야합니다.</p><h2 id="network-policy">Network Policy</h2><p>이정도 살펴보았으면, 아마 Kubernetes 에서 Network Policy 가 어떤식으로 구현되어있는지 감이 오실 것입니다.</p><p>네 맞습니다, <code class="language-plaintext highlighter-rouge">iptables</code> 가 또 나옵니다. 이번에는 Kube-proxyt가 아니라 CNI 가 Network Policy 구현에 신경을 쓰게 됩니다.</p><p>이번 섹션은 Calico(Part 2) 가 추가 되어야만 하지만, 지금쯤 Network Policy의 디테일이 나오는 것이 맞다고 생각했습니다.</p><p>자, 3가지 서비스를 만들어보죠. Frontend, Backend 그리고 DB</p><p>기본적으로, Pods 는 non-isolated 되어있습니다. 즉, 어디서 들어오든지 모든 트래픽을 수용합니다.</p><p><img width="909" alt="image" src="https://github.com/hhhyunwoo/leetcode/assets/37402136/629899e9-df01-47ac-8b8c-390b375da0ed" /></p><p>하지만, Frontend 와 DB간의 트래픽 흐름을 피하기 위해서는 FrondEnd 파드에서 DB 파드로의 트래픽을 제어할 필요가 있습니다.</p><p><img width="912" alt="image" src="https://github.com/hhhyunwoo/leetcode/assets/37402136/05d3f6bc-44c9-4fa0-87a0-f1000239471e" /></p><p>Network Policy 구성에 대해서 이해하기 위해서는 <a href="https://cloud.redhat.com/blog/guide-to-kubernetes-ingress-network-policies">이 칼럼</a>을 읽어보는 것을 권장합니다. 이번 섹션은 Netowork Policy 구성에 대한 딥 다이브 대신 Kubernetes에서 Network Policy가 어떻게 구현되었는지에 초점을 맞출 것입니다.</p><p>저는 먼저 DB와 Frontend 의 네트워크를 제어하기 위해서 Network Policy를 적용해두었습니다.</p><p>아래의 결과에서는 frontend 와 db 파드간의 연결은 없을 것입니다.</p><p><em>Note: 위의 그림은 서비스에 수많은 파드가 붙을 수 있다는 것을 보여주기 위해서 파드 아이콘 대신에 서비스 아이콘을 사용했습니다. 하지만 실제로 제어 규칙은 파드 단위로 적용됩니다.</em></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>master <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> frontend-8b474f47-zdqdv <span class="nt">--</span> /bin/sh
<span class="nv">$ </span>curl backend
backend-867fd6dff-mjf92
<span class="nv">$ </span>curl db
curl: <span class="o">(</span>7<span class="o">)</span> Failed to connect to db port 80: Connection timed out
</pre></table></code></div></div><p>하지만, Backend 는 db 서비스로 문제없이 도달할 수 있습니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>master <span class="nv">$ </span>kubectl <span class="nb">exec</span> <span class="nt">-it</span> backend-867fd6dff-mjf92 <span class="nt">--</span> /bin/sh
<span class="nv">$ </span>curl db
db-8d66ff5f7-bp6kf
</pre></table></code></div></div><p>이제 그럼 Network Policy에 대해서 들여다보죠.</p><p>만약 <code class="language-plaintext highlighter-rouge">allow-db-access</code> 값이 <code class="language-plaintext highlighter-rouge">true</code> 로 label 이 붙어있다면, 서비스로부터 들어오는 트레픽을 허용하는 것입니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre><span class="nt">---</span>
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-db-access
spec:
  podSelector:
    matchLabels:
      <span class="k">**</span>app: <span class="s2">"db"</span><span class="k">**</span>
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          <span class="k">**</span>networking/allow-db-access: <span class="s2">"true"</span><span class="k">**</span>
<span class="nt">---</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  labels:
    app: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
        <span class="k">**</span>networking/allow-db-access: <span class="s2">"true"</span><span class="k">**</span>
    spec:
      volumes:
      - name: workdir
        emptyDir: <span class="o">{}</span>
      containers:
      - name: nginx
        image: nginx:1.14.2
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
        volumeMounts:
        - name: workdir
          mountPath: /usr/share/nginx/html
      initContainers:
      - name: <span class="nb">install
        </span>image: busybox
        imagePullPolicy: IfNotPresent
        <span class="nb">command</span>: <span class="o">[</span><span class="s1">'sh'</span>, <span class="s1">'-c'</span>, <span class="s2">"echo </span><span class="nv">$HOSTNAME</span><span class="s2"> &gt; /work-dir/index.html"</span><span class="o">]</span>
        volumeMounts:
        - name: workdir
          mountPath: <span class="s2">"/work-dir"</span>
...
</pre></table></code></div></div><p>Calico 는 Kubernetes 의 Network Policy 를 Calico 네이티브 한 포맷으로 변경합니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>master <span class="nv">$ </span>calicoctl get networkPolicy <span class="nt">--output</span> yaml
apiVersion: projectcalico.org/v3
items:
- apiVersion: projectcalico.org/v3
  kind: NetworkPolicy
  metadata:
    creationTimestamp: <span class="s2">"2020-11-05T05:26:27Z"</span>
    name: knp.default.allow-db-access
    namespace: default
    resourceVersion: /53872
    uid: 1b3eb093-b1a8-4429-a77d-a9a054a6ae90
  spec:
    ingress:
    - action: Allow
      destination: <span class="o">{}</span>
      <span class="nb">source</span>:
        selector: projectcalico.org/orchestrator <span class="o">==</span> <span class="s1">'k8s'</span> <span class="o">&amp;&amp;</span> networking/allow-db-access
          <span class="o">==</span> <span class="s1">'true'</span>
    order: 1000
    selector: projectcalico.org/orchestrator <span class="o">==</span> <span class="s1">'k8s'</span> <span class="o">&amp;&amp;</span> app <span class="o">==</span> <span class="s1">'db'</span>
    types:
    - Ingress
kind: NetworkPolicyList
metadata:
  resourceVersion: 56821/56821
</pre></table></code></div></div><p>iptables 규칙은 <code class="language-plaintext highlighter-rouge">filter</code> 테이블을 사용하여 정책을 강화하는데 중요한 역할을 합니다.</p><p>Calico 가 강화된 개념의 <code class="language-plaintext highlighter-rouge">ipset</code> 을 사용하기 때문에 이 상황에서 리버스 엔지니어링을 하는 것은 매우 힘든 부분입니다. iptables 규칙에서 패킷이 backend 에서 출발해야만 db 파드로 들어오는 것을 허용하는 규칙을 볼 수 있습니다. 그리고 정확히 이 부분이 Network Policy가 하고 있는 부분입니다.</p><p>calicoctl 을 사용해서 Workload 엔드포인트 디테일을 확인해보죠</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>master <span class="nv">$ </span>calicoctl get workloadEndpoint
WORKLOAD                         NODE       NETWORKS        INTERFACE         
backend-867fd6dff-mjf92          minikube   10.88.0.27/32   cali2b1490aa46a   
db-8d66ff5f7-bp6kf               minikube   10.88.0.26/32   cali95aa86cbb2a   
frontend-8b474f47-zdqdv          minikube   10.88.0.24/32   cali505cfbeac50
</pre></table></code></div></div><p><em><strong>cali95aa86cbb2a</strong> -</em> db 파드에서 사용중인 Veth 쌍 중 Host 사이드에 위치하고 있는 것</p><p>그럼 이제 해당 인터페이스와 연관있는 iptables 규칙을 확인해봅시다!</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">sudo </span>iptables-save | <span class="nb">grep </span>cali95aa86cbb2a
:cali-fw-cali95aa86cbb2a - <span class="o">[</span>0:0]
:cali-tw-cali95aa86cbb2a - <span class="o">[</span>0:0]
<span class="nt">-A</span> cali-from-wl-dispatch <span class="nt">-i</span> cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:R489GtivXlno-SCP"</span> <span class="nt">-g</span> cali-fw-cali95aa86cbb2a
<span class="nt">-A</span> cali-fw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:3XN24uu3MS3PMvfM"</span> <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> RELATED,ESTABLISHED <span class="nt">-j</span> ACCEPT
<span class="nt">-A</span> cali-fw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:xyfc0rlfldUi6JAS"</span> <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> INVALID <span class="nt">-j</span> DROP
<span class="nt">-A</span> cali-fw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:wG4_76ot8e_QgXek"</span> <span class="nt">-j</span> MARK <span class="nt">--set-xmark</span> 0x0/0x10000
<span class="nt">-A</span> cali-fw-cali95aa86cbb2a <span class="nt">-p</span> udp <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:Ze6pH1ZM5N1pe76G"</span> <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"Drop VXLAN encapped packets originating in pods"</span> <span class="nt">-m</span> multiport <span class="nt">--dports</span> 4789 <span class="nt">-j</span> DROP
<span class="nt">-A</span> cali-fw-cali95aa86cbb2a <span class="nt">-p</span> ipencap <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:3bjax7tRUEJ2Uzew"</span> <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"Drop IPinIP encapped packets originating in pods"</span> <span class="nt">-j</span> DROP
<span class="nt">-A</span> cali-fw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:0pCFB_VsKq1qUOGl"</span> <span class="nt">-j</span> cali-pro-kns.default
<span class="nt">-A</span> cali-fw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:mbgUOxlInVlwb2Ie"</span> <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"Return if profile accepted"</span> <span class="nt">-m</span> mark <span class="nt">--mark</span> 0x10000/0x10000 <span class="nt">-j</span> RETURN
<span class="nt">-A</span> cali-fw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:I7GVOQegh6Wd9EMv"</span> <span class="nt">-j</span> cali-pro-ksa.default.default
<span class="nt">-A</span> cali-fw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:g5ViWVLiyVrKX91C"</span> <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"Return if profile accepted"</span> <span class="nt">-m</span> mark <span class="nt">--mark</span> 0x10000/0x10000 <span class="nt">-j</span> RETURN
<span class="nt">-A</span> cali-fw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:RBmQDo38EoPmxJ0I"</span> <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"Drop if no profiles matched"</span> <span class="nt">-j</span> DROP
<span class="nt">-A</span> cali-to-wl-dispatch <span class="nt">-o</span> cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:v3sEoNToLYUOg7M6"</span> <span class="nt">-g</span> cali-tw-cali95aa86cbb2a
<span class="nt">-A</span> cali-tw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:eCrqwxNk3cKw9Eq6"</span> <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> RELATED,ESTABLISHED <span class="nt">-j</span> ACCEPT
<span class="nt">-A</span> cali-tw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:_krp5nzavhAu5avJ"</span> <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> INVALID <span class="nt">-j</span> DROP
<span class="nt">-A</span> cali-tw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:Cu-tVtfKKu413YTT"</span> <span class="nt">-j</span> MARK <span class="nt">--set-xmark</span> 0x0/0x10000
<span class="nt">-A</span> cali-tw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:leBL64hpAXM9y4nk"</span> <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"Start of policies"</span> <span class="nt">-j</span> MARK <span class="nt">--set-xmark</span> 0x0/0x20000
<span class="nt">-A</span> cali-tw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:pm-LK-c1ra31tRwz"</span> <span class="nt">-m</span> mark <span class="nt">--mark</span> 0x0/0x20000 <span class="nt">-j</span> cali-pi-_tTE-E7yY40ogArNVgKt
<span class="nt">-A</span> cali-tw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:q_zG8dAujKUIBe0Q"</span> <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"Return if policy accepted"</span> <span class="nt">-m</span> mark <span class="nt">--mark</span> 0x10000/0x10000 <span class="nt">-j</span> RETURN
<span class="nt">-A</span> cali-tw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:FUDVBYh1Yr6tVRgq"</span> <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"Drop if no policies passed packet"</span> <span class="nt">-m</span> mark <span class="nt">--mark</span> 0x0/0x20000 <span class="nt">-j</span> DROP
<span class="nt">-A</span> cali-tw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:X19Z-Pa0qidaNsMH"</span> <span class="nt">-j</span> cali-pri-kns.default
<span class="nt">-A</span> cali-tw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:Ljj0xNidsduxDGUb"</span> <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"Return if profile accepted"</span> <span class="nt">-m</span> mark <span class="nt">--mark</span> 0x10000/0x10000 <span class="nt">-j</span> RETURN
<span class="nt">-A</span> cali-tw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:0z9RRvvZI9Gud0Wv"</span> <span class="nt">-j</span> cali-pri-ksa.default.default
<span class="nt">-A</span> cali-tw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:pNCpK-SOYelSULC1"</span> <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"Return if profile accepted"</span> <span class="nt">-m</span> mark <span class="nt">--mark</span> 0x10000/0x10000 <span class="nt">-j</span> RETURN
<span class="nt">-A</span> cali-tw-cali95aa86cbb2a <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:sMkvrxvxj13WlTMK"</span> <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"Drop if no profiles matched"</span> <span class="nt">-j</span> DROP
<span class="nv">$ </span><span class="nb">sudo </span>iptables-save <span class="nt">-t</span> filter | <span class="nb">grep </span>cali-pi-_tTE-E7yY40ogArNVgKt
:cali-pi-_tTE-E7yY40ogArNVgKt - <span class="o">[</span>0:0]
<span class="nt">-A</span> cali-pi-_tTE-E7yY40ogArNVgKt <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:M4Und37HGrw6jUk8"</span> <span class="nt">-m</span> <span class="nb">set</span> <span class="nt">--match-set</span> cali40s:LrVD8vMIGQDyv8Y7sPFB1Ge src <span class="nt">-j</span> MARK <span class="nt">--set-xmark</span> 0x10000/0x10000
<span class="nt">-A</span> cali-pi-_tTE-E7yY40ogArNVgKt <span class="nt">-m</span> comment <span class="nt">--comment</span> <span class="s2">"cali:sEnlfZagUFRSPRoe"</span> <span class="nt">-m</span> mark <span class="nt">--mark</span> 0x10000/0x10000 <span class="nt">-j</span> RETURN
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">ipset</code> 을 확인해보면, backend pod ip 인 10.88.0.27 로부터 db pod 로 들어오는 것만 허용한다는 것이 명확히 보입니다.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>minikube <span class="nv">$ </span>ipset list
Name: cali40s:LrVD8vMIGQDyv8Y7sPFB1Ge
Type: <span class="nb">hash</span>:net
Revision: 6
Header: family inet hashsize 1024 maxelem 1048576
Size <span class="k">in </span>memory: 408
References: 3
Number of entries: 1
Members:
10.88.0.27
</pre></table></code></div></div><h2 id="references"><strong>References</strong></h2><ul><li><code class="language-plaintext highlighter-rouge">[https://kubernetes.io](https://kubernetes.io/)</code><li><code class="language-plaintext highlighter-rouge">https://www.projectcalico.org/</code><li><code class="language-plaintext highlighter-rouge">https://rancher.com/</code><li><code class="language-plaintext highlighter-rouge">http://www.netfilter.org/</code></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/packet/" class="post-tag no-text-decoration" >packet</a> <a href="/tags/network/" class="post-tag no-text-decoration" >network</a> <a href="/tags/translation/" class="post-tag no-text-decoration" >translation</a> <a href="/tags/cni/" class="post-tag no-text-decoration" >cni</a> <a href="/tags/iptables/" class="post-tag no-text-decoration" >iptables</a> <a href="/tags/kube-proxy/" class="post-tag no-text-decoration" >kube-proxy</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[번역] Life of a Packet in Kubernetes— Part 3 - Hans H. Kim&url=https://hhhyunwoo.github.io//posts/eng_life-of-a-packet-in-k8s/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[번역] Life of a Packet in Kubernetes— Part 3 - Hans H. Kim&u=https://hhhyunwoo.github.io//posts/eng_life-of-a-packet-in-k8s/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=[번역] Life of a Packet in Kubernetes— Part 3 - Hans H. Kim&url=https://hhhyunwoo.github.io//posts/eng_life-of-a-packet-in-k8s/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/blog-newjourney/">🏢 첫번째 퇴사, 첫번째 이직</a><li><a href="/posts/k8s-nginx-413-error/">[K8S] Ingress Nginx 413 http error (payload too large) 이슈 해결</a><li><a href="/posts/infiniband-nccl-issue/">[Infiniband] NCCL WARN Call to ibv_reg_mr failed 이슈 해결</a><li><a href="/posts/k8s_service/">[Kubernetes] Kubernetes 서비스 정리(ClusterIP, Nodeport, Loadbalancer) </a><li><a href="/posts/k8s-kernel-epoll-etcd-leader/">[K8S] 5.4.0-132 커널의 epoll 버그로 인한 etcd leader election 이슈</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/github-pages/">GitHub Pages</a> <a class="post-tag" href="/tags/jekyll-theme/">jekyll theme</a> <a class="post-tag" href="/tags/jekyll/">jekyll</a> <a class="post-tag" href="/tags/next-theme/">NexT theme</a> <a class="post-tag" href="/tags/%EC%A7%80%ED%82%AC-%EB%B8%94%EB%A1%9C%EA%B7%B8-%ED%8F%AC%EC%8A%A4%ED%8C%85/">지킬 블로그 포스팅</a> <a class="post-tag" href="/tags/%EC%A7%80%ED%82%AC-%ED%85%8C%EB%A7%88/">지킬 테마</a> <a class="post-tag" href="/tags/computer-science/">Computer Science</a> <a class="post-tag" href="/tags/%EA%B0%9C%EB%B0%9C/">개발</a> <a class="post-tag" href="/tags/%EC%86%8C%ED%94%84%ED%8A%B8%EC%9B%A8%EC%96%B4/">소프트웨어</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/eng_k8s-flannel-networking/"><div class="card-body"> <span class="timeago small" >May 31, 2023<i class="unloaded">2023-05-31T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[번역] Kubernetes: Flannel Networking</h3><div class="text-muted small"><p> 해당 Posting 을 공부하며 번역하는 글입니다. 해당 포스팅은 쿠버네티스 환경에서 flannel 네트워크가 어떻게 동작하는지를 설명하는 글입니다. 쿠버네티스는 규모에 맞게 컨테이너화 된 애플리케이션을 관리하는데 굉장히 유용한 도구입니다. 하지만 여러분도 아시다시피, 쿠버네티스를 학습하는 것은 쉽지만은 않습니다. 특히 네트워크 구현의 백...</p></div></div></a></div><div class="card"> <a href="/posts/k8s_service/"><div class="card-body"> <span class="timeago small" >Feb 14, 2022<i class="unloaded">2022-02-14T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[Kubernetes] Kubernetes 서비스 정리(ClusterIP, Nodeport, Loadbalancer)</h3><div class="text-muted small"><p> Kubernetes Service ClusterIP 말 그대로 클러스터 내부에서 사용하는 IP 클러스터 내부의 노드나 파드에서는 ClusterIP를 이용해서 서비스에 연결된 각 파드들에 접근한다. 하지만 외부에서는 이 IP로 접근 불가능 apiVersion: v1 kind: Service metadata: name: test spec: ...</p></div></div></a></div><div class="card"> <a href="/posts/k8s-kubeconfig/"><div class="card-body"> <span class="timeago small" >Apr 21, 2022<i class="unloaded">2022-04-21T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[K8S] Kubectx 사용 시 선택한 kubeconfig 를 제대로 못 불러오는 문제 해결</h3><div class="text-muted small"><p> Kubectx 사용 시 선택한 kubeconfig 를 제대로 못 불러오는 문제 해결 DOCS 여기에 거의 모든 정보가 나와있다. 나는 Kubectx 라는 툴을 사용해서 다중 클러스터를 선택하고 있다. (매우 유용함!!) 근데 클러스터 몇 개를 추가했더니, 선택한 새로운 클러스터 정보를 가져오는 것이 아니라 계속 똑같은 정보만 가져오는 것이...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/network-study-ch12/" class="btn btn-outline-primary" prompt="Older"><p>[CISCO 네트워킹] 12. IPv6 로 떠나는 여행</p></a> <a href="/posts/eng_k8s-flannel-networking/" class="btn btn-outline-primary" prompt="Newer"><p>[번역] Kubernetes: Flannel Networking</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/hhhyunwoo">Hans H. Kim</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/github-pages/">GitHub Pages</a> <a class="post-tag" href="/tags/jekyll-theme/">jekyll theme</a> <a class="post-tag" href="/tags/jekyll/">jekyll</a> <a class="post-tag" href="/tags/next-theme/">NexT theme</a> <a class="post-tag" href="/tags/%EC%A7%80%ED%82%AC-%EB%B8%94%EB%A1%9C%EA%B7%B8-%ED%8F%AC%EC%8A%A4%ED%8C%85/">지킬 블로그 포스팅</a> <a class="post-tag" href="/tags/%EC%A7%80%ED%82%AC-%ED%85%8C%EB%A7%88/">지킬 테마</a> <a class="post-tag" href="/tags/computer-science/">Computer Science</a> <a class="post-tag" href="/tags/%EA%B0%9C%EB%B0%9C/">개발</a> <a class="post-tag" href="/tags/%EC%86%8C%ED%94%84%ED%8A%B8%EC%9B%A8%EC%96%B4/">소프트웨어</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-EPY53PE167"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-EPY53PE167'); }); </script>
